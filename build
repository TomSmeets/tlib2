#!/bin/bash
set -euo pipefail

FLAGS="-Wall -Werror \
       -Wno-unused-function \
       -Wno-unused-variable \
       -Wno-unused-but-set-variable \
       -std=c23 \
       "

DEBUG="-g -O0"
RELEASE="-g0 -O2 -Xlinker --strip-all"

WINDOWS="-target x86_64-unknown-windows-gnu"

WASM="-target wasm32 \
      --no-standard-libraries \
      -Wl,--no-entry \
      -Wl,--export-all \
      -fno-builtin \
      -msimd128 \
      "

LINUX=""
mkdir -p out

# Generate compile commands for some platform
cat > compile_commands.json <<EOF
[
  {
    "directory":"$PWD",
    "command":"clang $FLAGS $DEBUG $LINUX -Icore -Igfx -Ielf -o main main.c",
    "file":"main.c"
  }
]
EOF

# Run clang-format
clang-format -i */*.h */*.c

# Build everything
mkdir -p out/tmp
clang $FLAGS $DEBUG $LINUX   -o out/tmp/tmp.elf  -Icore app/tmp.c
clang $FLAGS $DEBUG $WINDOWS -o out/tmp/tmp.exe  -Icore app/tmp.c
clang $FLAGS $DEBUG $WASM    -o out/tmp/tmp.wasm -Icore app/tmp.c
cat app/tmp.html    > out/tmp/tmp.html
cat core/os_wasm.js > out/tmp/tmp.js

mkdir -p out/snake
clang $FLAGS $DEBUG $LINUX   -o out/snake/snake      -Icore -Igfx snake/snake.c
clang $FLAGS $DEBUG $WINDOWS -o out/snake/snake.exe  -Icore -Igfx snake/snake.c
# clang $FLAGS $DEBUG $WASM    -o out/snake/snake.wasm -Icore -Igfx snake/snake.c

clang $FLAGS $DEBUG $LINUX   -o out/test       -Icore       app/test.c
clang $FLAGS $DEBUG $LINUX   -o out/hot        -Icore -Ielf app/hot.c
clang $FLAGS $DEBUG $LINUX   -o out/build      -Icore -Ielf app/build.c

